import io from 'socket.io-client'; // –ò–º–ø–æ—Ä—Ç Socket.IO –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
import envConfig from '../../config/environment-config'; // –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è URL —Å–µ—Ä–≤–µ—Ä–∞

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è WebSocket
let socket = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
let isConnected = false; // –§–ª–∞–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É (true/false)
let reconnectAttempts = 0; // –°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
const maxReconnectAttempts = 5; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
const reconnectDelay = 1000; // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
let heartbeatInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ heartbeat –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
let connectionCheckInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
let lastSessionEvent = null; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–±—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
let sessionEventTimeout = null; // –¢–∞–π–º–∞—É—Ç –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π —Å–µ—Å—Å–∏–∏
let isConnecting = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (–∑–∞—â–∏—Ç–∞ –æ—Ç React StrictMode)

  // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
export async function connect() {
  try {
    // console.log('üîå WebSocket: –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–¥–µ—Ç –ª–∏ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–∑–∞—â–∏—Ç–∞ –æ—Ç React StrictMode –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤)
    if (isConnecting) {
      // console.log('üîå WebSocket: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º'); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
      return false; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false, —Ç–∞–∫ –∫–∞–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
    }
    
    // –ï—Å–ª–∏ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    if (socket && socket.connected) {
      // console.log('üîå WebSocket: –£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö'); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
      return true; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º true, —Ç–∞–∫ –∫–∞–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    }
    
    isConnecting = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ localStorage –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤)
    const token = localStorage.getItem('accessToken'); // –ò–∑–≤–ª–µ–∫–∞–µ–º JWT —Ç–æ–∫–µ–Ω –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –±—Ä–∞—É–∑–µ—Ä–∞
      
      if (!token) {
      // console.log('üîå WebSocket: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ'); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
      isConnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ–∫–µ–Ω–∞
      return false; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false, —Ç–∞–∫ –∫–∞–∫ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
    }

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–π socket, –æ—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç –Ω–µ–≥–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
    if (socket && !socket.connected) {
      // console.log('üîå WebSocket: –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...'); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
      disconnect(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    }

    // console.log('‚úÖ WebSocket: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    const socketConfig = envConfig.getSocketIOConfig(); // –ü–æ–ª—É—á–∞–µ–º URL –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    // console.log('üîå WebSocket: SocketConfig:', socketConfig); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
           
           // –ü–æ–ª—É—á–∞–µ–º WebSocket CSRF —Ç–æ–∫–µ–Ω –∏–∑ –∫—É–∫–æ–≤ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
           const getWebSocketCSRFToken = () => { // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –∏–∑ –∫—É–∫–æ–≤
             const cookies = document.cookie.split(';'); // –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∫—É–∫–æ–≤ –ø–æ —Å–∏–º–≤–æ–ª—É ';' –Ω–∞ –º–∞—Å—Å–∏–≤
             for (let cookie of cookies) { // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –∫–∞–∂–¥—ã–π –∫—É–∫ –≤ –º–∞—Å—Å–∏–≤–µ
               const [name, value] = cookie.trim().split('='); // –†–∞–∑–¥–µ–ª—è–µ–º –∫—É–∫ –Ω–∞ –∏–º—è –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —Å–∏–º–≤–æ–ª—É '='
               if (name === 'wsCSRFToken') { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ WebSocket CSRF —Ç–æ–∫–µ–Ω–æ–º
                 return value; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
               }
             }
             return null; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º null, –µ—Å–ª–∏ CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω
           };
           
           let wsCSRFToken = getWebSocketCSRFToken(); // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ –∫—É–∫–æ–≤
           console.log('WebSocket: WebSocket CSRF —Ç–æ–∫–µ–Ω:', wsCSRFToken ? '–µ—Å—Ç—å' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'); // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
           
           // –ï—Å–ª–∏ WebSocket CSRF —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –µ–≥–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ API –∑–∞–ø—Ä–æ—Å
           if (!wsCSRFToken) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ CSRF —Ç–æ–∫–µ–Ω
             console.log('WebSocket: WebSocket CSRF —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å...'); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
             try { // –ù–∞—á–∏–Ω–∞–µ–º –±–ª–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
               const { fetchWebSocketCSRFToken } = await import('../auth/store/store.js'); // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
               await fetchWebSocketCSRFToken(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
               console.log('WebSocket: WebSocket CSRF —Ç–æ–∫–µ–Ω –∑–∞–ø—Ä–æ—à–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–∫–∏...'); // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞
               
               // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–∫–∏ —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤–æ–≥–æ CSRF —Ç–æ–∫–µ–Ω–∞
               const newWSCSRFToken = getWebSocketCSRFToken(); // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π CSRF —Ç–æ–∫–µ–Ω –∏–∑ –∫—É–∫–æ–≤
               console.log('WebSocket: WebSocket CSRF —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞:', newWSCSRFToken ? '–µ—Å—Ç—å' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'); // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
               
               if (newWSCSRFToken) { // –ï—Å–ª–∏ –Ω–æ–≤—ã–π CSRF —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω
                 console.log('WebSocket: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π WebSocket CSRF —Ç–æ–∫–µ–Ω'); // –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
                 wsCSRFToken = newWSCSRFToken; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –Ω–æ–≤—ã–π CSRF —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
               }
             } catch (csrfError) { // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ CSRF —Ç–æ–∫–µ–Ω–∞
               console.error('WebSocket: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è WebSocket CSRF —Ç–æ–∫–µ–Ω–∞:', csrfError); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
             }
           }

           // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º URL –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
           console.log('üîå WebSocket: –°–æ–∑–¥–∞–µ–º Socket.IO —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å URL:', socketConfig.url); // –õ–æ–≥–∏—Ä—É–µ–º URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
           console.log('üîå WebSocket: –û–ø—Ü–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', { // –õ–æ–≥–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
             auth: { // –û–±—ä–µ–∫—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
               token: token ? '—Ç–æ–∫–µ–Ω –µ—Å—Ç—å' : '—Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç', // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ JWT —Ç–æ–∫–µ–Ω–∞
               csrfToken: wsCSRFToken ? 'CSRF —Ç–æ–∫–µ–Ω –µ—Å—Ç—å' : 'CSRF —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç' // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
             },
             ...socketConfig.options // –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
           });
           
           // –°–æ–∑–¥–∞–µ–º socket —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
           const socketOptions = { // –û–±—ä–µ–∫—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è Socket.IO —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
             auth: { // –û–±—ä–µ–∫—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
               token: token, // JWT —Ç–æ–∫–µ–Ω –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
               csrfToken: wsCSRFToken // CSRF —Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∞—Ç–∞–∫
             },
             transports: ['websocket', 'polling'], // –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤ –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (WebSocket –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π)
             timeout: 10000, // –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
             forceNew: true, // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
             autoConnect: false // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤—Ä—É—á–Ω—É—é
           };
           
           socket = io(socketConfig.url, socketOptions); // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä Socket.IO –∫–ª–∏–µ–Ω—Ç–∞ —Å URL –∏ –æ–ø—Ü–∏—è–º–∏

           console.log('üîå WebSocket: Socket.IO –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω:', socket ? '—É—Å–ø–µ—à–Ω–æ' : '–æ—à–∏–±–∫–∞'); // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è socket –æ–±—ä–µ–∫—Ç–∞
           console.log('üîå WebSocket: Socket –æ–±—ä–µ–∫—Ç:', socket); // –õ–æ–≥–∏—Ä—É–µ–º —Å–∞–º socket –æ–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

           // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
           socket.connect(); // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É

    // –ñ–¥–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º Promise –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è
    return new Promise((resolve) => { // –°–æ–∑–¥–∞–µ–º Promise –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      const timeout = setTimeout(() => { // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è
        console.error('üîå WebSocket: –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Ç–∞–π–º–∞—É—Ç–∞
        isConnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ
        resolve(false); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
      }, 5000); // –£–º–µ–Ω—å—à–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞

      socket.on('connect', () => { // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
        clearTimeout(timeout); // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–∞—É—Ç, —Ç–∞–∫ –∫–∞–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
        isConnected = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        isConnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        reconnectAttempts = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        console.log('‚úÖ WebSocket: –ü–æ–¥–∫–ª—é—á–µ–Ω–æ'); // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ª–æ–≥
        // console.log('üîå WebSocket: Socket ID:', socket.id); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
        // console.log('üîå WebSocket: –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ URL:', socket.io?.uri); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
        // console.log('üîå WebSocket: –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:', socket.io?.engine?.transport?.name); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
        
        // –ù–ï –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ –∞–¥–º–∏–Ω–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —Å–µ—Ä–≤–µ—Ä —Å–∞–º –¥–æ–±–∞–≤–∏—Ç –∫–ª–∏–µ–Ω—Ç–∞
        // –≤ –Ω—É–∂–Ω—É—é –∫–æ–º–Ω–∞—Ç—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è 'authenticated'
        // socket.emit('join_room', 'admins_room'); // –£–±—Ä–∞–Ω–æ - –∫–ª–∏–µ–Ω—Ç –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–º–Ω–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º heartbeat –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        startHeartbeat(); // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É heartbeat –ø–∞–∫–µ—Ç–æ–≤
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        setupEventHandlers(); // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö WebSocket —Å–æ–±—ã—Ç–∏–π
        
        resolve(true); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º true –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
      });

      socket.on('connect_error', async (error) => { // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket
        clearTimeout(timeout); // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        isConnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        console.error('üîå WebSocket: –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error.message); // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        console.error('üîå WebSocket: –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –ø–æ–ø—ã—Ç–∫–æ–π refresh —Ç–æ–∫–µ–Ω–∞
        if (error.message.includes('Token expired')) { // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫
          console.log('üîå WebSocket: –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ refresh...'); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É refresh
          
          try { // –ù–∞—á–∏–Ω–∞–µ–º –±–ª–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ refresh
            // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º axios –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è refresh –∑–∞–ø—Ä–æ—Å–∞
            const axios = (await import('axios')).default; // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç axios
            const { API_CONFIG } = await import('../../config/api.js'); // –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ API
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä axios –¥–ª—è refresh –∑–∞–ø—Ä–æ—Å–∞
            const refreshAxios = axios.create({ // –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ axios
              baseURL: API_CONFIG.BASE_URL, // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ URL
              withCredentials: true // –í–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫—É–∫–æ–≤ —Å refresh —Ç–æ–∫–µ–Ω–æ–º
            });
            
            console.log('üîå WebSocket: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ /auth/refresh...'); // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å refresh
            const { data } = await refreshAxios.get('/auth/refresh'); // –í—ã–ø–æ–ª–Ω—è–µ–º GET –∑–∞–ø—Ä–æ—Å –Ω–∞ refresh
            
            if (data && data.accessToken) { // –ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π access —Ç–æ–∫–µ–Ω
              console.log('üîå WebSocket: –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π accessToken, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage'); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
              localStorage.setItem('accessToken', data.accessToken); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
              console.log('üîå WebSocket: –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...'); // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
              
              // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
              setTimeout(() => connect(), 500); // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —á–µ—Ä–µ–∑ 500–º—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
              resolve(false); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø–æ–ø—ã—Ç–∫–∏ (–Ω–æ–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ 500–º—Å)
              return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
            }
            
            // –ï—Å–ª–∏ refresh –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–æ–∫–µ–Ω
            console.log('üîå WebSocket: Refresh –Ω–µ –≤–µ—Ä–Ω—É–ª accessToken, –æ—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω—ã'); // –õ–æ–≥–∏—Ä—É–µ–º –æ—á–∏—Å—Ç–∫—É
            localStorage.removeItem('accessToken'); // –£–¥–∞–ª—è–µ–º access —Ç–æ–∫–µ–Ω
            
          } catch (refreshError) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ refresh
            console.error('üîå WebSocket: –û—à–∏–±–∫–∞ refresh —Ç–æ–∫–µ–Ω–∞:', refreshError); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É refresh
            console.log('üîå WebSocket: Refresh –Ω–µ —É–¥–∞–ª—Å—è, –æ—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω—ã'); // –õ–æ–≥–∏—Ä—É–µ–º –æ—á–∏—Å—Ç–∫—É
            localStorage.removeItem('accessToken'); // –£–¥–∞–ª—è–µ–º access —Ç–æ–∫–µ–Ω
          }
        } else if (error.message.includes('Invalid token') || error.message.includes('Token is required')) { // –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ —Ç–æ–∫–µ–Ω–∞
          console.log('üîå WebSocket: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω, –æ—á–∏—â–∞–µ–º'); // –õ–æ–≥–∏—Ä—É–µ–º –æ—á–∏—Å—Ç–∫—É
          localStorage.removeItem('accessToken'); // –£–¥–∞–ª—è–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
        }
        
        resolve(false); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      });
    });
    } catch (error) {
    console.error('WebSocket: –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
    isConnecting = false;
      return false;
    }
  }

// –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç WebSocket —Å–µ—Ä–≤–µ—Ä–∞
export function disconnect() {
  console.log('üîå WebSocket: –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
  
  if (socket) {
    console.log('üîå WebSocket: –í—ã–∑—ã–≤–∞–µ–º socket.disconnect()');
    socket.disconnect();
    socket = null;
  } else {
    console.log('üîå WebSocket: socket —É–∂–µ null, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º disconnect');
  }
  
  isConnected = false;
  isConnecting = false;
  
  // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
  if (heartbeatInterval) {
    clearInterval(heartbeatInterval);
    heartbeatInterval = null;
  }
  
  if (connectionCheckInterval) {
    clearInterval(connectionCheckInterval);
    connectionCheckInterval = null;
  }
  
  if (sessionEventTimeout) {
    clearTimeout(sessionEventTimeout);
    sessionEventTimeout = null;
    }
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
export async function getValidToken() {
    try {
 //   console.log('üîå WebSocket: –ü–æ–ª—É—á–∞–µ–º –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω...');
    
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –∏–∑ localStorage
      const storedToken = localStorage.getItem('accessToken');
 //   console.log('üîå WebSocket: –¢–æ–∫–µ–Ω –∏–∑ localStorage:', storedToken ? '–µ—Å—Ç—å' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
    
      if (storedToken) {
   //   console.log('üîå WebSocket: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –∏–∑ localStorage');
        return storedToken;
      }

      // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ store
   // console.log('üîå WebSocket: –¢–æ–∫–µ–Ω–∞ –≤ localStorage –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º store...');
      const { useAuthStore } = await import('../auth/store/store.js');
      const { isAuth, token } = useAuthStore.getState();
    
    //console.log('üîå WebSocket: –°–æ—Å—Ç–æ—è–Ω–∏–µ store - isAuth:', isAuth, 'token:', token ? '–µ—Å—Ç—å' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
      
      if (isAuth && token) {
      console.log('üîå WebSocket: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –∏–∑ store');
        return token;
      }

      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
    console.log('üîå WebSocket: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è');
      return null;
    } catch (error) {
    console.error('üîå WebSocket: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
      return null;
    }
  }

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function setupEventHandlers() {
  if (!socket) {
    console.log('üîå WebSocket: setupEventHandlers - socket –Ω–µ —Å–æ–∑–¥–∞–Ω');
    return;
  }

  console.log('üîå WebSocket: setupEventHandlers - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π');

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ connect()
  // –ó–¥–µ—Å—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ heartbeat –æ—Ç–≤–µ—Ç–∞
  socket.on('heartbeat_response', (data) => {
    console.log('üîå WebSocket: –ü–æ–ª—É—á–µ–Ω heartbeat_response:', data); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
  socket.on('disconnect', (reason) => {
    isConnected = false;
    console.log('‚ö†Ô∏è WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', reason); // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ª–æ–≥
    
    // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
    if (heartbeatInterval) {
      clearInterval(heartbeatInterval);
      heartbeatInterval = null;
    }
    
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
    handleReconnect();
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ connect()
  // –ó–¥–µ—Å—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  socket.on('notification', (notification) => {
    console.log('üì¨ WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ "notification":', notification.type);
    handleSecureNotification(notification);
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ª–æ–≥–∞—É—Ç–∞
  socket.on('force_logout', async (data) => {
    console.log('üîê WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ "force_logout":', data);
    try {
      // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º store –¥–ª—è –≤—ã–∑–æ–≤–∞ logout
      const { useAuthStore } = await import('../auth/store/store.js');
      const logout = useAuthStore.getState().logout;
      
      if (logout) {
        console.log('üîê WebSocket: –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ª–æ–≥–∞—É—Ç');
        await logout();
        
        // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç WebSocket
        disconnect();
        
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
        window.location.href = '/login';
      }
    } catch (error) {
      console.error('üîê WebSocket: –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ª–æ–≥–∞—É—Ç–∞:', error);
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
      window.location.href = '/login';
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ
  socket.on('support_new_message', (data) => {
    console.log('üí¨ WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ "support_new_message":', data);
    const event = new CustomEvent('support-new-message', { detail: data });
    document.dispatchEvent(event);
    console.log('‚úÖ WS: –°–æ–±—ã—Ç–∏–µ support-new-message –∑–∞–¥–∏—Å–ø–∞—Ç—á–µ–Ω–æ');
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö –±–µ—Å–µ–¥ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ
  socket.on('support_new_conversation', (data) => {
    console.log('üì¨ WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ "support_new_conversation":', data);
    const event = new CustomEvent('crm-new-conversation', { detail: data });
    document.dispatchEvent(event);
    console.log('‚úÖ WS: –°–æ–±—ã—Ç–∏–µ crm-new-conversation –∑–∞–¥–∏—Å–ø–∞—Ç—á–µ–Ω–æ');
  });

  socket.on('admin:document_status_updated', (data) => {
    console.log('üìÑ WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ "admin:document_status_updated":', data);
    const event = new CustomEvent('admin-document-status-updated', { detail: data });
    document.dispatchEvent(event);
  });

  socket.on('admin:document_uploaded', (data) => {
    console.log('üìÑ WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ "admin:document_uploaded":', data);
    const event = new CustomEvent('admin-document-uploaded', { detail: data });
    document.dispatchEvent(event);
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  socket.on('authenticated', (data) => {
    console.log('‚úÖ WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ "authenticated":', data);
    if (data.userType === 'user') {
      console.log(`‚úÖ WebSocket: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.userId} —É—Å–ø–µ—à–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–º–Ω–∞—Ç–µ user_${data.userId}`);
    } else if (data.userType === 'admin') {
      console.log(`‚úÖ WebSocket: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ${data.userId} —É—Å–ø–µ—à–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω`);
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  console.log('üîå WebSocket: –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ "user:document_status_updated"');
  socket.on('user:document_status_updated', (data) => {
    console.log('üìÑ WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ "user:document_status_updated":', data);
    console.log('üìÑ WebSocket: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º CustomEvent "user-document-status-updated" –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç');
    const event = new CustomEvent('user-document-status-updated', { detail: data });
    document.dispatchEvent(event);
    console.log('üìÑ WebSocket: CustomEvent "user-document-status-updated" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
  });
  console.log('‚úÖ WebSocket: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ "user:document_status_updated" –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª –ø—Ä–æ–¥—É–∫—Ç–∞
  console.log('üîå WebSocket: –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ "product:investment_rules_updated"');
  socket.on('product:investment_rules_updated', (data) => {
    console.log('üìÑ WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ "product:investment_rules_updated":', data);
    console.log('üìÑ WebSocket: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º CustomEvent "product-investment-rules-updated" –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç');
    const event = new CustomEvent('product-investment-rules-updated', { detail: data });
    document.dispatchEvent(event);
    console.log('üìÑ WebSocket: CustomEvent "product-investment-rules-updated" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
    
    // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ (–µ—Å–ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã admins_room)
    const adminEvent = new CustomEvent('admin-product-investment-rules-updated', { detail: data });
    document.dispatchEvent(adminEvent);
    console.log('üìÑ WebSocket: CustomEvent "admin-product-investment-rules-updated" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è –∞–¥–º–∏–Ω–∫–∏');
  });
  console.log('‚úÖ WebSocket: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ "product:investment_rules_updated" –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ —É–±—Ä–∞–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä—è–º–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
  socket.on('session_connected', async (sessionData) => {
    // console.log('WebSocket: –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∞:', sessionData); // –û—Ç–∫–ª—é—á–µ–Ω–æ
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
    // –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ WebSocket
    const currentUserId = await getCurrentUserId();
    if (currentUserId && sessionData.id === currentUserId && sessionData.type === 'user') {
      console.log('WebSocket: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–±–∞—É–Ω—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    debounceSessionEvent('session-connected', sessionData);
  });

  socket.on('session_disconnected', async (sessionData) => {
    // console.log('WebSocket: –°–µ—Å—Å–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞:', sessionData); // –û—Ç–∫–ª—é—á–µ–Ω–æ
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
    // –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ WebSocket
    const currentUserId = await getCurrentUserId();
    if (currentUserId && sessionData.id === currentUserId && sessionData.type === 'user') {
      console.log('WebSocket: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–±–∞—É–Ω—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    debounceSessionEvent('session-disconnected', sessionData);
  });

         // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
         socket.on('session_terminated', async (data) => { // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ 'session_terminated' –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
           console.log('WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ session_terminated:', data); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
           
           // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
           try { // –ù–∞—á–∏–Ω–∞–µ–º –±–ª–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
             const { useAuthStore } = await import('../auth/store/store.js'); // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º store
             const { user, admin } = useAuthStore.getState(); // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–¥–º–∏–Ω–∞ –∏–∑ store
             
             // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
             const currentUserId = user?.id || null; // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–µ—Ç –±—ã—Ç—å null)
             const currentAdminId = admin?.id || null; // ID —Ç–µ–∫—É—â–µ–≥–æ –∞–¥–º–∏–Ω–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å null)
             
             console.log('WebSocket: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è —Å–æ–±—ã—Ç–∏—è:'); // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏
             console.log('  - –¢–µ–∫—É—â–∏–π userId:', currentUserId); // –õ–æ–≥–∏—Ä—É–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
             console.log('  - –¢–µ–∫—É—â–∏–π adminId:', currentAdminId); // –õ–æ–≥–∏—Ä—É–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –∞–¥–º–∏–Ω–∞
             console.log('  - –¶–µ–ª–µ–≤–æ–π userId:', data.targetUserId); // –õ–æ–≥–∏—Ä—É–µ–º —Ü–µ–ª–µ–≤–æ–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–æ–±—ã—Ç–∏—è
             console.log('  - –¶–µ–ª–µ–≤–æ–π adminId:', data.targetAdminId); // –õ–æ–≥–∏—Ä—É–µ–º —Ü–µ–ª–µ–≤–æ–π ID –∞–¥–º–∏–Ω–∞ –∏–∑ —Å–æ–±—ã—Ç–∏—è
             console.log('  - –¢–∏–ø —Ü–µ–ª–µ–≤–æ–π —Å–µ—Å—Å–∏–∏:', data.userType); // –õ–æ–≥–∏—Ä—É–µ–º —Ç–∏–ø –∑–∞–≤–µ—Ä—à–∞–µ–º–æ–π —Å–µ—Å—Å–∏–∏
             
             // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ü–µ–ª—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
             const isTargetUser = data.userType === 'user' && data.targetUserId === currentUserId; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
             const isTargetAdmin = data.userType === 'admin' && data.targetAdminId === currentAdminId; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
             
             if (!isTargetUser && !isTargetAdmin) { // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –ù–ï –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
               console.log('WebSocket: –°–æ–±—ã—Ç–∏–µ session_terminated –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º'); // –õ–æ–≥–∏—Ä—É–µ–º –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
               return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏–π
             }
             
             console.log('WebSocket: –°–æ–±—ã—Ç–∏–µ session_terminated –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º'); // –õ–æ–≥–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
             
             // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏—á–∏–Ω—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
             let message = '–í–∞—à–∞ —Å–µ—Å—Å–∏—è –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞'; // –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
             if (data.reason === 'new_login') { // –ï—Å–ª–∏ –ø—Ä–∏—á–∏–Ω–∞ - –Ω–æ–≤—ã–π –≤—Ö–æ–¥
               message = '–í—ã –±—ã–ª–∏ –≤—ã–≤–µ–¥–µ–Ω—ã –∏–∑ —Å–∏—Å—Ç–µ–º—ã, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–æ–∏–∑–æ—à–µ–ª –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ –≤ –≤–∞—à—É —É—á–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å'; // –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ
             } else if (data.reason === 'admin_terminated') { // –ï—Å–ª–∏ –ø—Ä–∏—á–∏–Ω–∞ - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
               message = '–í–∞—à–∞ —Å–µ—Å—Å–∏—è –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º'; // –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–æ–º
             }
             
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ alert
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º SUCCESS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
             document.dispatchEvent(new CustomEvent('main-notify', {
               detail: {
                 type: 'success',
                 text: message
               }
             }));
             
             // –û—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω—ã –∏–∑ localStorage
             localStorage.removeItem('accessToken'); // –£–¥–∞–ª—è–µ–º access —Ç–æ–∫–µ–Ω
             localStorage.removeItem('refreshToken'); // –£–¥–∞–ª—è–µ–º refresh —Ç–æ–∫–µ–Ω
             
             // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ store
             const { logout } = useAuthStore.getState(); // –ü–æ–ª—É—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é logout –∏–∑ store
             await logout(); // –í—ã–∑—ã–≤–∞–µ–º logout –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
             console.log('WebSocket: –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—á–∏—â–µ–Ω–æ'); // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –æ—á–∏—Å—Ç–∫—É
             
             // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
             document.dispatchEvent(new CustomEvent('session-terminated', { // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ
               detail: { ...data, message } // –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ detail
             }));
             
             // –û—Ç–∫–ª—é—á–∞–µ–º WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
             disconnect(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–∫–ª—é—á–µ–Ω–∏—è WebSocket
             
           } catch (error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
             console.error('WebSocket: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ session_terminated:', error); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
             // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ - –ù–ï –∑–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ)
           }
         });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
export function getCurrentUserId() {
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π import –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
    return import('../auth/store/store.js').then(({ useAuthStore }) => {
      const { user } = useAuthStore.getState();
      return user?.id || null;
    }).catch(error => {
      console.error('WebSocket: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      return null;
    });
    } catch (error) {
    console.error('WebSocket: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    return null;
  }
}

// –î–µ–±–∞—É–Ω—Å –¥–ª—è —Å–æ–±—ã—Ç–∏–π —Å–µ—Å—Å–∏–π
function debounceSessionEvent(eventType, sessionData, delay = 500) {
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
  if (sessionEventTimeout) {
    clearTimeout(sessionEventTimeout);
  }

  // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —Å–æ–±—ã—Ç–∏—è
  const eventKey = `${eventType}_${sessionData.id}_${sessionData.type}`;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ –Ω–µ–¥–∞–≤–Ω–æ —Ç–∞–∫–æ–≥–æ –∂–µ —Å–æ–±—ã—Ç–∏—è
  const now = Date.now();
  if (lastSessionEvent && 
      lastSessionEvent.key === eventKey && 
      (now - lastSessionEvent.timestamp) < delay) {
    console.log(`WebSocket: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—É–±–ª–∏—Ä—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ ${eventType} –¥–ª—è ${sessionData.email}`);
    return;
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±—ã—Ç–∏–∏
  lastSessionEvent = {
    key: eventKey,
    timestamp: now
  };

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏—è
  sessionEventTimeout = setTimeout(() => {
    document.dispatchEvent(new CustomEvent(eventType, { 
      detail: sessionData 
    }));
  }, delay);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function handleSecureNotification(notification) { // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ WebSocket
  // console.log('WebSocket: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', notification); // –û—Ç–∫–ª—é—á–µ–Ω–æ - —Å–ø–∞–º
  
  try { // –ù–∞—á–∏–Ω–∞–µ–º –±–ª–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
    if (!notification || !notification.type) { // –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ –±–µ–∑ —Ç–∏–ø–∞
      console.warn('WebSocket: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ–ª–µ–π:', notification); // –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è INFO-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π
    if (notification.type === 'INFO') { // –ï—Å–ª–∏ —ç—Ç–æ INFO —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      // console.log('WebSocket: INFO —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'); // –û—Ç–∫–ª—é—á–µ–Ω–æ
      document.dispatchEvent(new CustomEvent('main-notify-info-refresh'));
    } else if (notification.type === 'POST') { // –ï—Å–ª–∏ —ç—Ç–æ POST —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ—Ç—á–µ—Ç)
      // console.log('WebSocket: POST —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'); // –û—Ç–∫–ª—é—á–µ–Ω–æ
      document.dispatchEvent(new CustomEvent('main-notify-post-refresh'));
    } else if (notification.type === 'NEW_SUPPORT_CONVERSATION') { // –ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
      console.log('üì¨ CRM: –ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ #' + notification.conversationId + ' (' + notification.priority + ')');
      document.dispatchEvent(new CustomEvent('crm-new-conversation', { detail: notification }));
    } else if (notification.type === 'NEW_SUPPORT_MESSAGE') { // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
      console.log('üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—Ä–∞—â–µ–Ω–∏–∏ #' + notification.conversationId);
      console.log('üì§ WS: –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ support-new-message');
      const event = new CustomEvent('support-new-message', { detail: notification });
      document.dispatchEvent(event);
      console.log('‚úÖ WS: –°–æ–±—ã—Ç–∏–µ support-new-message –∑–∞–¥–∏—Å–ø–∞—Ç—á–µ–Ω–æ');
    } else { // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      // console.log('WebSocket: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–∏–ø–∞', notification.type); // –û—Ç–∫–ª—é—á–µ–Ω–æ
    }
  } catch (error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    console.error('WebSocket: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
  }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
function handleReconnect() {
  if (reconnectAttempts < maxReconnectAttempts) {
    reconnectAttempts++;
    console.log(`üîå WebSocket: –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts}`);
    
    setTimeout(() => {
      connect();
    }, reconnectDelay * reconnectAttempts);
        } else {
    console.error('üîå WebSocket: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ');
  }
}

// –ó–∞–ø—É—Å–∫ heartbeat
function startHeartbeat() {
  if (heartbeatInterval) {
    clearInterval(heartbeatInterval);
  }
  
  heartbeatInterval = setInterval(() => {
    if (socket && isConnected) {
      console.log('üîå WebSocket: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º heartbeat...');
      socket.emit('heartbeat', { 
        timestamp: new Date().toISOString(),
        userId: socket.userId || socket.adminId 
      });
    }
  }, 20000); // Heartbeat –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥ (–º–µ–Ω—å—à–µ —á–µ–º pingInterval —Å–µ—Ä–≤–µ—Ä–∞ 25 —Å–µ–∫)
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –æ —Å–º–µ–Ω–µ —Ä–æ–ª–∏ (–≤—ã—Ö–æ–¥ –∏–∑ –∞–¥–º–∏–Ω–∫–∏)
export function switchToUserRole() {
  if (socket && isConnected) {
    console.log('WebSocket: –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é —Ä–æ–ª—å');
    socket.emit('role_switch', { 
      userType: 'user',
      timestamp: new Date().toISOString()
    });
  }
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –æ –≤—Ö–æ–¥–µ –≤ –∞–¥–º–∏–Ω–∫—É
export function switchToAdminRole() {
  if (socket && isConnected) {
    console.log('WebSocket: –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é —Ä–æ–ª—å');
    socket.emit('role_switch', { 
      userType: 'admin',
      timestamp: new Date().toISOString()
    });
    }
  }

  // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
export async function reconnect() {
  disconnect();
  await connect();
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
export function sendToUser(userId, message) {
  if (socket && isConnected) {
    socket.emit('send_to_user', { userId, message });
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
export function sendToAllUsers(message) {
  if (socket && isConnected) {
    socket.emit('broadcast_message', { message });
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
export function getConnectionStatus() {
  return {
    isConnected,
    reconnectAttempts,
    socket: !!socket
  };
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ socket –æ–±—ä–µ–∫—Ç–∞
export function getSocket() {
  return socket;
}

// –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
const websocketService = {
  connect,
  disconnect,
  getValidToken,
  getCurrentUserId,
  switchToUserRole,
  switchToAdminRole,
  reconnect,
  sendToUser,
  sendToAllUsers,
  getConnectionStatus,
  getSocket,
  // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
  on: (event, callback) => {
    if (socket && isConnected) {
      socket.on(event, callback);
    }
  },
  off: (event, callback) => {
    if (socket) {
      socket.off(event, callback);
    }
  }
};

export default websocketService;